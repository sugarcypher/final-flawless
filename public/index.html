<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flawless Finish Ceramic Coating – Palm Springs & Coachella Valley</title>
  <meta name="description" content="Premium automotive ceramic coating with transparent pricing, real-time calendar booking with $250 deposit, and meticulous multi-stage prep for desert conditions." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="images/favicon.png">
</head>
<body>
  <header class="hero">
    <div class="wrap">
      <div>
        <div class="logo-section">
          <img src="images/flawless-finish-logo.png" alt="Flawless Finish Ceramic Coating Logo" class="logo">
        </div>
        <h1>Flawless Finish Ceramic Coating</h1>
        <p class="lead">Desert‑luxe ceramic protection for Palm Springs & Coachella Valley — UV, heat, and sand defense with mirror‑grade gloss.</p>
        <div class="badges">
          <span class="badge">Owner: Jason (Jay)</span>
          <span class="badge">Call: 442‑342‑3627</span>
          <span class="badge">Deposit: $250</span>
          <span class="badge">Mobile & Shop Service</span>
        </div>
        <div class="cta-row">
          <a href="#booking" class="button primary">Book Now</a>
          <a href="#pricing" class="button secondary">See Pricing</a>
        </div>
      </div>
      <div class="card dark">
        <h2 style="margin-top:0">What You Get</h2>
        <p class="sub">Engineered process for harsh desert conditions.</p>
        <ul>
          <li>Decontamination, clay, polish, panel wipe</li>
          <li>2–5 year ceramic options</li>
          <li>Hydrophobic, UV & oxidation resistant</li>
          <li>Glass & wheel coating add‑ons</li>
        </ul>
      </div>
    </div>
  </header>

  <main>
    <section class="section light gallery-section">
      <div class="container">
        <h2>Ceramic Gallery</h2>
        <p class="sub">Premium ceramic coating results from Palm Springs & Coachella Valley</p>
        <div class="gallery">
          <div class="gallery-item">
            <img src="images/gallery/bmw-interior-dashboard.jpg" alt="BMW M interior with ceramic coating on dashboard">
            <div class="gallery-caption">Interior Dashboard Protection</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/057FFDFF-A80A-4DF3-8735-3710F23DCCEE.jpeg" alt="Professional ceramic coating work">
            <div class="gallery-caption">Professional Ceramic Coating</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/3839ED0E-8F5A-40E3-9F22-2F911F6627B1.jpeg" alt="High-quality ceramic coating results">
            <div class="gallery-caption">Premium Results</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/6CF20334-6867-4342-A413-556E0D905B8E_1_105_c.jpeg" alt="Ceramic coating detail work">
            <div class="gallery-caption">Detail Work</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/70DB7259-DC31-4EC2-913D-F8A373EBDB38_1_105_c.jpeg" alt="Ceramic coating application">
            <div class="gallery-caption">Expert Application</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/70FDC29D-56A6-47A8-AFC5-DB2F69BCA841_1_105_c.jpeg" alt="Ceramic coating transformation">
            <div class="gallery-caption">Complete Transformation</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/749F8F04-9A69-4A87-9429-C1BBA9335E7F_1_105_c.jpeg" alt="Professional detailing work">
            <div class="gallery-caption">Professional Detailing</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/7D953D53-8255-4D6E-9C69-62585AB09E28_1_105_c.jpeg" alt="Ceramic coating finish">
            <div class="gallery-caption">Flawless Finish</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/9F36238E-7005-43C1-AD72-0206771E5AE0_1_105_c.jpeg" alt="High-end ceramic coating">
            <div class="gallery-caption">High-End Protection</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/9F871EEB-B45D-4866-BD38-628EEA5F68D8_1_105_c.jpeg" alt="Ceramic coating results">
            <div class="gallery-caption">Premium Results</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/A382230E-5034-4041-86B3-4A7AE10DF928.jpeg" alt="Professional ceramic work">
            <div class="gallery-caption">Professional Work</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/B2040A7B-381B-493E-81E0-1F86560EB65A.jpeg" alt="Ceramic coating application">
            <div class="gallery-caption">Expert Application</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/C00CD066-53A0-4AA6-A96A-202C53EF3D05_1_105_c.jpeg" alt="Ceramic coating detail">
            <div class="gallery-caption">Attention to Detail</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/CE0C9E15-4FDA-4ED7-BF37-8FDBA44F23EA.jpeg" alt="Ceramic coating finish">
            <div class="gallery-caption">Perfect Finish</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/ED593E8B-486F-46CA-BC83-8B06226C1B83_1_105_c.jpeg" alt="Ceramic coating transformation">
            <div class="gallery-caption">Amazing Transformation</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/FE9424FB-2A65-478A-8774-F4A98D9E4BF0.jpeg" alt="Ceramic coating results">
            <div class="gallery-caption">Outstanding Results</div>
          </div>
        </div>
        <div class="gallery-cta">
          <a href="#booking" class="button primary">Book Your Ceramic Coating</a>
          <a href="#pricing" class="button secondary">View Pricing</a>
        </div>
      </div>
    </section>

    <section class="section dark before-after-section">
      <div class="container">
        <h2>Before & After Gallery</h2>
        <p class="sub">See the transformation - from damaged to flawless</p>
        <div class="before-after-gallery">
          <div class="before-after-item">
            <div class="before-after-image">
              <img src="images/before-after/paint-swirls-before.jpg" alt="Paint with swirl marks and scratches - before">
              <div class="before-after-label">Before</div>
            </div>
            <div class="before-after-image">
              <img src="images/before-after/paint-mirror-finish-after.jpg" alt="Perfect mirror finish after ceramic coating - after">
              <div class="before-after-label">After</div>
            </div>
            <div class="before-after-caption">Paint Correction & Ceramic Coating</div>
          </div>
          <div class="before-after-item">
            <div class="before-after-image">
              <img src="images/before-after/before.png" alt="Vehicle before ceramic coating treatment">
              <div class="before-after-label">Before</div>
            </div>
            <div class="before-after-image">
              <img src="images/before-after/after.png" alt="Vehicle after ceramic coating treatment - flawless finish">
              <div class="before-after-label">After</div>
            </div>
            <div class="before-after-caption">Scratch Removal</div>
          </div>
        </div>
        <div class="before-after-cta">
          <a href="#booking" class="button primary">Transform Your Vehicle</a>
          <a href="tel:4423423627" class="button secondary">Call (442) 342-3627</a>
        </div>
      </div>
    </section>

    <section class="section about-me">
      <div class="container">
        <div class="about-content">
          <div class="about-text">
            <h2>About Me</h2>
            <p class="lead">Upgrading Great to Excellence</p>
            <p>Hi, I'm Jason — the owner and operator of Flawless Finish Ceramic Coating here in sunny Palm Springs. My passion for cars started early. I began high-speed buffing at just 15 years old, and for the past <strong>28 years</strong> I've been perfecting my craft — restoring shine, depth, and protection to vehicles of all kinds.</p>
            
            <p>Originally from the Midwest, I bring those Indiana values of hard work, fairness, and loyalty into everything I do. At Flawless Finish, my focus is simple: deliver superior results and make every vehicle look better than new.</p>
            
            <p>For me, detailing isn't just about appearance — it's about pride, precision, and helping people fall in love with their cars all over again.</p>
            
            <p class="highlight">When you choose Flawless Finish Ceramic Coating, you're not just getting a service — you're getting a commitment to excellence.</p>
            
            <div class="credentials">
              <div class="credential">
                <span class="number">28</span>
                <span class="label">Years Experience</span>
              </div>
              <div class="credential">
                <span class="number">15</span>
                <span class="label">Started Age</span>
              </div>
              <div class="credential">
                <span class="number">∞</span>
                <span class="label">Cars Restored</span>
              </div>
            </div>
          </div>
          <div class="about-image">
            <img src="images/jason-headshot.jpg" alt="Jason - Owner of Flawless Finish Ceramic Coating" />
            <div class="image-caption">
              <strong>Jason</strong><br>
              Owner & Master Detailer
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="section testimonials">
      <div class="container">
        <h2>Clients in the Valley</h2>
        <p class="sub">Proof beats promises — what drivers say after living with the coating.</p>
        <div class="testi-grid">
          <div class="testi">
            <h3>"Desert dust just won't stick."</h3>
            <p>Six months later and rinses take minutes. The water beading hasn't quit.</p>
            <div class="by">— M., Indio</div>
          </div>
          <div class="testi">
            <h3>"Looks better than delivery day."</h3>
            <p>Paint correction + 5‑year coating. It turns heads in the sun.</p>
            <div class="by">— A., Palm Springs</div>
          </div>
          <div class="testi">
            <h3>"Professional, punctual, meticulous."</h3>
            <p>Explained each step. Zero surprises. Booking my SUV next.</p>
            <div class="by">— J.R., La Quinta</div>
          </div>
        </div>
      </div>
    </section>

    <section id="pricing" class="section light pricing-section">
      <div class="container">
        <h2>Transparent Pricing</h2>
        <p class="sub">No hidden costs, no extra fees—what you see is what the price is.</p>
        <div class="pricing-grid">
          <div class="pricing-card">
            <h3>Cars</h3>
            <div class="price">$800</div>
            <div class="description">Minimal Paint Correction</div>
            <ul>
              <li>Decontamination wash</li>
              <li>Clay bar treatment</li>
              <li>Light polish</li>
              <li>2-year ceramic coating</li>
            </ul>
            <a href="#booking" class="button primary">Book This Service</a>
          </div>
          <div class="pricing-card featured">
            <h3>Cars</h3>
            <div class="price">$900</div>
            <div class="description">Moderate Paint Correction</div>
            <ul>
              <li>Full decontamination</li>
              <li>Clay bar treatment</li>
              <li>Multi-stage polish</li>
              <li>3-year ceramic coating</li>
            </ul>
            <a href="#booking" class="button primary">Book This Service</a>
          </div>
          <div class="pricing-card">
            <h3>Cars</h3>
            <div class="price">$1,100</div>
            <div class="description">Heavy Paint Correction</div>
            <ul>
              <li>Complete decontamination</li>
              <li>Clay bar treatment</li>
              <li>Heavy compounding & polish</li>
              <li>5-year ceramic coating</li>
            </ul>
            <a href="#booking" class="button primary">Book This Service</a>
          </div>
        </div>
        <div class="pricing-note">
          <p><strong>Trucks/SUVs:</strong> Add $100 to each price above</p>
          <p><strong>Glass & Rims:</strong> Add $100-$150 depending on correction level</p>
        </div>
      </div>
    </section>

    <section class="section light process-section">
      <div class="container">
        <h2>Our Process</h2>
        <p class="sub">Meticulous preparation for lasting results</p>
        <div class="process-grid">
          <div class="process-step">
            <div class="step-number">1</div>
            <h3>Initial Inspection</h3>
            <p>Walk-around assessment with Jason and vehicle owner to identify scratches, swirl marks, oxidation, and contamination that need attention.</p>
          </div>
          <div class="process-step">
            <div class="step-number">2</div>
            <h3>Decontamination</h3>
            <p>Pre-wash and thorough decontamination using pH-neutral shampoo and iron removers to strip away old waxes, sealants, and embedded contaminants.</p>
          </div>
          <div class="process-step">
            <div class="step-number">3</div>
            <h3>Clay Bar Treatment</h3>
            <p>Clay bar used to remove any remaining bonded debris, leaving the surface smooth and ready for paint correction.</p>
          </div>
          <div class="process-step">
            <div class="step-number">4</div>
            <h3>Paint Correction</h3>
            <p>High-speed buffing/compounding to eliminate deeper imperfections and polishing to enhance gloss and remove swirl marks.</p>
          </div>
          <div class="process-step">
            <div class="step-number">5</div>
            <h3>Final Preparation</h3>
            <p>Final inspection under bright lighting and IPA solution wipe to remove any remaining oils or residues before coating application.</p>
          </div>
          <div class="process-step">
            <div class="step-number">6</div>
            <h3>Ceramic Coating</h3>
            <p>Ceramic coating applied one panel at a time. Once fully cured (7 days), you'll only need water to rinse and dry!</p>
          </div>
        </div>
      </div>
    </section>

    <section id="booking" class="booking-section">
      <div class="container">
        <div class="booking-container">
          <h2>Book Your Ceramic Coating</h2>
          <p class="sub">Select your preferred date and complete your booking</p>
          
          <div class="calendar-container">
            <h3>Available Dates</h3>
            <div id="calendar">
              <!-- Calendar will be populated by JavaScript -->
            </div>
            <div id="selectedDate" class="selected-date-display"></div>
            <div id="timeSlotContainer" style="display: none; margin-top: 16px;">
              <label for="timeSlot" style="display: block; margin-bottom: 8px; font-weight: 600;">Select Time Slot</label>
              <select id="timeSlot" name="timeSlot" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">Choose a time...</option>
                <option value="morning">Morning (8:00 AM - 12:00 PM)</option>
                <option value="afternoon">Afternoon (12:00 PM - 5:00 PM)</option>
                <option value="evening">Evening (5:00 PM - 8:00 PM)</option>
              </select>
            </div>
            <div id="nextSlot" class="text-center mb-20"></div>
          </div>

          <form class="booking-form" id="bookingForm">
            <div class="form-group">
              <label for="customerName">Full Name</label>
              <input type="text" id="customerName" name="customerName" required>
            </div>
            
            <div class="form-group">
              <label for="customerPhone">Phone Number</label>
              <input type="tel" id="customerPhone" name="customerPhone" required>
            </div>
            
            <div class="form-group">
              <label for="vehicleYear">Vehicle Year</label>
              <input type="number" id="vehicleYear" name="vehicleYear" min="1900" max="2030" required>
            </div>
            
            <div class="form-group">
              <label for="vehicleMake">Vehicle Make</label>
              <input type="text" id="vehicleMake" name="vehicleMake" placeholder="e.g., BMW, Mercedes, Tesla" required>
            </div>
            
            <div class="form-group">
              <label for="vehicleModel">Vehicle Model</label>
              <input type="text" id="vehicleModel" name="vehicleModel" placeholder="e.g., M5, Model S, E-Class" required>
            </div>
            
            <div class="form-group">
              <label for="vehicleTrim">Vehicle Trim</label>
              <input type="text" id="vehicleTrim" name="vehicleTrim" placeholder="e.g., Competition, Performance, AMG">
            </div>
            
            <div class="form-group">
              <label for="vehicleColor">Vehicle Color</label>
              <input type="text" id="vehicleColor" name="vehicleColor" placeholder="e.g., Black, White, Metallic Gray" required>
            </div>
            
            <div class="form-group">
              <label for="serviceLevel">Service Level</label>
              <select id="serviceLevel" name="serviceLevel" required>
                <option value="">Select Service Level</option>
                <option value="minimal">Minimal Paint Correction - $800</option>
                <option value="moderate">Moderate Paint Correction - $900</option>
                <option value="heavy">Heavy Paint Correction - $1,100</option>
              </select>
            </div>

            <div class="payment-section">
              <h3>Payment Options</h3>
              <div class="payment-options">
                <button type="button" id="cashBooking" class="button secondary">Book with Cash Payment</button>
                <button type="button" id="cardBooking" class="button primary">Pay $250 Deposit</button>
              </div>
              
              <div id="paymentForm" style="display: none;">
                <div id="payment-element">
                  <!-- Stripe Elements will be inserted here -->
                </div>
                <button type="submit" id="submit-payment" class="button primary">Pay $250 Deposit</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </section>
  </main>

  <footer class="section dark">
    <div class="container">
      <div class="text-center">
        <h3>Flawless Finish Ceramic Coating</h3>
        <p>Palm Springs & Coachella Valley</p>
        <p>Call: <a href="tel:4423423627" style="color: #007bff;">(442) 342-3627</a></p>
        <p>Owner: Jason (Jay)</p>
        <p><a href="privacy.html" style="color:#007bff">Privacy</a> · <a href="security.html" style="color:#007bff">Security</a> · <a href="settings.html" style="color:#007bff">Privacy & Security Settings</a></p>
      </div>
    </div>
  </footer>

  <script>
    // Professional booking calendar functionality
    document.addEventListener('DOMContentLoaded', function() {
      const calendar = document.getElementById('calendar');
      const nextSlot = document.getElementById('nextSlot');
      const cashBooking = document.getElementById('cashBooking');
      const cardBooking = document.getElementById('cardBooking');
      const paymentForm = document.getElementById('paymentForm');
      const bookingForm = document.getElementById('bookingForm');
      
      let selectedDate = null;
      let stripe = null;
      let elements = null;
      let currentMonth = new Date().getMonth();
      let currentYear = new Date().getFullYear();
      let bookedDatesCache = new Set();
      
      // Helpers to avoid timezone shifts and build month views
      function ymd(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      }
      function humanFromYMD(ymdStr) {
        const [y, m, d] = ymdStr.split('-').map(Number);
        const date = new Date(Date.UTC(y, m - 1, d));
        return date.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' });
      }
      function daysInMonth(year, monthIndex) {
        return new Date(year, monthIndex + 1, 0).getDate();
      }
      
      // Load calendar - single month with navigation
      function loadCalendar() {
        if (!calendar) {
          console.error('Calendar element not found');
          return;
        }
        console.log('Loading calendar...');
        fetchCalendarFromAPI();
      }
      
      function renderSingleMonth(year, monthIndex, bookedDates) {
        if (!calendar) return;
        
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                            'July', 'August', 'September', 'October', 'November', 'December'];
        const now = new Date();
        const dim = daysInMonth(year, monthIndex);
        const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const viewingStart = new Date(year, monthIndex, 1);
        
        calendar.innerHTML = '';
        
        // Month navigation header
        const navHeader = document.createElement('div');
        navHeader.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 8px;';
        
        // Build dropdown options for current month through 6 months ahead
        const currentMonthIdx = now.getMonth();
        const currentYearNum = now.getFullYear();
        const options = [];
        for (let offset = 0; offset < 6; offset++) {
          const targetDate = new Date(currentYearNum, currentMonthIdx + offset, 1);
          const optYear = targetDate.getFullYear();
          const optMonth = targetDate.getMonth();
          const optValue = `${optYear}-${optMonth}`;
          const isSelected = optYear === year && optMonth === monthIndex;
          options.push(`<option value="${optValue}" ${isSelected ? 'selected' : ''}>${monthNames[optMonth]} ${optYear}</option>`);
        }
        
        navHeader.innerHTML = `
          <button id="prevMonth" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; min-width: 44px;">‹</button>
          <select id="monthSelect" style="padding: 8px 16px; font-size: 16px; font-weight: 600; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; flex: 1; max-width: 250px; margin: 0 8px;">
            ${options.join('')}
          </select>
          <button id="nextMonth" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; min-width: 44px;">›</button>
        `;
        calendar.appendChild(navHeader);
        
        // Add navigation handlers (use onclick to avoid duplicate listeners)
        document.getElementById('prevMonth').onclick = () => {
          const now = new Date();
          const minMonth = now.getMonth();
          const minYear = now.getFullYear();
          const viewingDate = new Date(year, monthIndex, 1);
          const minDate = new Date(minYear, minMonth, 1);
          
          if (viewingDate > minDate) {
            if (monthIndex === 0) {
              currentMonth = 11;
              currentYear--;
            } else {
              currentMonth--;
            }
            renderSingleMonth(currentYear, currentMonth, bookedDatesCache);
          }
        };
        
        document.getElementById('nextMonth').onclick = () => {
          const now = new Date();
          const maxDate = new Date(now.getFullYear(), now.getMonth() + 5, 1);
          const viewingDate = new Date(year, monthIndex, 1);
          
          if (viewingDate < maxDate) {
            if (monthIndex === 11) {
              currentMonth = 0;
              currentYear++;
            } else {
              currentMonth++;
            }
            renderSingleMonth(currentYear, currentMonth, bookedDatesCache);
          }
        };
        
        document.getElementById('monthSelect').onchange = (e) => {
          const [selYear, selMonth] = e.target.value.split('-').map(Number);
          currentMonth = selMonth;
          currentYear = selYear;
          renderSingleMonth(currentYear, currentMonth, bookedDatesCache);
        };
        
        // Day headers
        const dayHeaders = document.createElement('div');
        dayHeaders.className = 'calendar-day-headers';
        dayHeaders.innerHTML = `
          <div class="day-header">Mon</div>
          <div class="day-header">Tue</div>
          <div class="day-header">Wed</div>
          <div class="day-header">Thu</div>
          <div class="day-header">Fri</div>
          <div class="day-header">Sat</div>
        `;
        calendar.appendChild(dayHeaders);
        
        // Month grid
        const calendarGrid = document.createElement('div');
        calendarGrid.className = 'calendar-days';
        
        for (let day = 1; day <= dim; day++) {
          const d = new Date(year, monthIndex, day);
          // Skip Sundays and any past dates in the current month
          if (d.getDay() === 0) continue;
          if (viewingStart < todayStart && d < todayStart) continue;
          const dateStr = ymd(d);
          const isBooked = bookedDates.has(dateStr);
          const dayElement = document.createElement('div');
          if (isBooked) {
            dayElement.className = 'calendar-day unavailable';
            dayElement.style.cursor = 'not-allowed';
            dayElement.textContent = String(day);
          } else {
            dayElement.className = 'calendar-day available';
            dayElement.textContent = String(day);
            dayElement.setAttribute('data-date', dateStr);
            dayElement.style.cursor = 'pointer';
            dayElement.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              selectDate(dateStr, dayElement);
            });
          }
          calendarGrid.appendChild(dayElement);
        }
        
        calendar.appendChild(calendarGrid);
      }
      
      async function fetchCalendarFromAPI() {
        try {
          // 6 months ahead (approx 180 days)
          const response = await fetch('/api/availability?days=185');
          
          if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
          }
          
          const data = await response.json();
          bookedDatesCache = new Set((data.days || []).filter(d => d.booked).map(d => d.date));
          
          // Find first available date
          const now = new Date();
          let firstAvailable = null;
          for (let i = 0; i < 185; i++) {
            const d = new Date(now);
            d.setDate(now.getDate() + i);
            if (d.getDay() === 0) continue; // Skip Sundays
            const dateStr = ymd(d);
            if (!bookedDatesCache.has(dateStr)) {
              firstAvailable = { date: dateStr, displayDate: humanFromYMD(dateStr) };
              break;
            }
          }
          
          nextSlot.innerHTML = firstAvailable
            ? `<p><strong>Next Available:</strong> ${firstAvailable.displayDate}</p>`
            : '<p>No available dates found in the next 6 months</p>';
          
          // Render current month
          console.log('Rendering calendar for', currentYear, currentMonth, 'with', bookedDatesCache.size, 'booked dates');
          renderSingleMonth(currentYear, currentMonth, bookedDatesCache);
        } catch (error) {
          console.error('Error loading calendar:', error);
          if (calendar) {
            calendar.innerHTML = `<div style="padding: 2rem; text-align: center; color: #666;">
              <p style="margin: 0;">Error loading calendar: ${error.message}</p>
              <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Retry</button>
            </div>`;
          }
          if (nextSlot) {
            nextSlot.innerHTML = '<p style="color: red;">Error loading calendar. Please refresh the page.</p>';
          }
        }
      }
      
      // Select date function
      function selectDate(date, element) {
        selectedDate = date;
        
        // Remove selected class from all days
        document.querySelectorAll('.calendar-day').forEach(day => {
          day.classList.remove('selected');
        });
        
        // Add selected class to clicked day
        if (element) {
          element.classList.add('selected');
        }
        
        // Show selected date
        const selectedDateDisplay = document.getElementById('selectedDate');
        if (selectedDateDisplay) {
          selectedDateDisplay.textContent = `Selected: ${humanFromYMD(date)}`;
        }
        
        // Show time slot selector
        const timeSlotContainer = document.getElementById('timeSlotContainer');
        if (timeSlotContainer) {
          timeSlotContainer.style.display = 'block';
        }
      }
      
      // Cash booking handler
      cashBooking.addEventListener('click', async function() {
        if (!validateForm()) return;
        
        try {
          const formData = {
            date: selectedDate,
            name: document.getElementById('customerName').value,
            phone: document.getElementById('customerPhone').value,
            timeSlot: document.getElementById('timeSlot').value,
            vehicleYear: document.getElementById('vehicleYear').value,
            vehicleMake: document.getElementById('vehicleMake').value,
            vehicleModel: document.getElementById('vehicleModel').value,
            vehicleTrim: document.getElementById('vehicleTrim').value,
            vehicleColor: document.getElementById('vehicleColor').value,
            serviceLevel: document.getElementById('serviceLevel').value,
            paymentMethod: 'cash'
          };
          
          const response = await fetch('/api/book-cash', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert('Thanks for booking! If you don\'t hear from Jason in the next hour, give him a call!');
            bookingForm.reset();
            selectedDate = null;
            document.querySelectorAll('.calendar-day').forEach(day => {
              day.classList.remove('selected');
            });
          } else {
            alert('Booking failed: ' + (result.message || 'Unknown error'));
          }
        } catch (error) {
          console.error('Booking error:', error);
          alert('Network error. Please try again.');
        }
      });
      
      // Card booking handler - prevent duplicate listeners
      let paymentHandlerAttached = false;
      cardBooking.addEventListener('click', async function() {
        if (!validateForm()) return;
        
        try {
          // Initialize Stripe
          if (!window.Stripe) {
            const script = document.createElement('script');
            script.src = 'https://js.stripe.com/v3/';
            document.head.appendChild(script);
            await new Promise(resolve => script.onload = resolve);
          }
          
          // Get Stripe publishable key
          const keyResponse = await fetch('/api/stripe-key');
          const keyData = await keyResponse.json();
          let publishableKey = (keyData?.publishableKey || '').trim();
          
          if (!publishableKey || typeof publishableKey !== 'string' || publishableKey.length === 0) {
            console.error('Stripe publishable key missing or empty. Response:', keyData);
            alert('Payment system not configured. The Stripe publishable key is missing. Please check Render environment variables.');
            return;
          }
          
          if (!publishableKey.startsWith('pk_')) {
            console.error('Invalid Stripe publishable key format (should start with pk_):', publishableKey.substring(0, Math.min(50, publishableKey.length)) + '...');
            alert('Payment system configuration error. The Stripe publishable key format is invalid. Expected format: pk_test_... or pk_live_...\n\nReceived: ' + publishableKey.substring(0, 20) + '...');
            return;
          }
          
          stripe = Stripe(publishableKey);
          
          // Create payment intent
          const formData = {
            date: selectedDate,
            name: document.getElementById('customerName').value,
            phone: document.getElementById('customerPhone').value,
            timeSlot: document.getElementById('timeSlot').value,
            vehicleYear: document.getElementById('vehicleYear').value,
            vehicleMake: document.getElementById('vehicleMake').value,
            vehicleModel: document.getElementById('vehicleModel').value,
            vehicleTrim: document.getElementById('vehicleTrim').value,
            vehicleColor: document.getElementById('vehicleColor').value,
            serviceLevel: document.getElementById('serviceLevel').value
          };

          // Persist booking info for post-redirect confirmation
          localStorage.setItem('ff_booking', JSON.stringify({
            date: formData.date,
            name: formData.name,
            phone: formData.phone,
            timeSlot: formData.timeSlot,
            vehicleYear: formData.vehicleYear,
            vehicleMake: formData.vehicleMake,
            vehicleModel: formData.vehicleModel,
            vehicleTrim: formData.vehicleTrim,
            vehicleColor: formData.vehicleColor,
            serviceLevel: formData.serviceLevel
          }));
          
          const response = await fetch('/api/create-payment-intent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });
          
          const result = await response.json();
          
          if (result.success) {
            // Clear and remount payment element if it exists
            const paymentElementContainer = document.getElementById('payment-element');
            if (paymentElementContainer) {
              paymentElementContainer.innerHTML = '';
            }
            
            // Initialize Stripe Elements
            elements = stripe.elements({ clientSecret: result.clientSecret });
            
            const paymentElement = elements.create('payment');
            paymentElement.mount('#payment-element');
            
            paymentForm.style.display = 'block';
            
            // Handle form submission - prevent duplicate listeners
            if (!paymentHandlerAttached) {
              bookingForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const { error, paymentIntent } = await stripe.confirmPayment({
                  elements,
                  confirmParams: {
                    return_url: window.location.href
                  }
                });
                
                if (error) {
                  alert('Payment failed: ' + error.message);
                  return;
                }

                // Some payments succeed immediately without redirect
                if (paymentIntent && paymentIntent.status === 'succeeded') {
                  try {
                    const bookingStored = JSON.parse(localStorage.getItem('ff_booking') || '{}');
                    const confirmRes = await fetch('/api/confirm-payment', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({
                        paymentIntentId: paymentIntent.id,
                        date: bookingStored.date || formData.date,
                        name: bookingStored.name || formData.name,
                        phone: bookingStored.phone || formData.phone,
                        timeSlot: bookingStored.timeSlot || formData.timeSlot,
                        vehicleYear: bookingStored.vehicleYear || formData.vehicleYear,
                        vehicleMake: bookingStored.vehicleMake || formData.vehicleMake,
                        vehicleModel: bookingStored.vehicleModel || formData.vehicleModel,
                        vehicleTrim: bookingStored.vehicleTrim || formData.vehicleTrim,
                        vehicleColor: bookingStored.vehicleColor || formData.vehicleColor,
                        serviceLevel: bookingStored.serviceLevel || formData.serviceLevel
                      })
                    });
                    const confirmJson = await confirmRes.json();
                    if (!confirmJson.success) {
                      alert('Booking confirmation failed: ' + (confirmJson.message || 'Unknown error'));
                      return;
                    }
                  } catch (e) {
                    console.error(e);
                    alert('Booking confirmation failed. Please contact us.');
                    return;
                  }

                  alert('Thanks for booking! If you don\'t hear from Jason in the next hour, give him a call!');
                  bookingForm.reset();
                  paymentForm.style.display = 'none';
                  selectedDate = null;
                  document.querySelectorAll('.calendar-day').forEach(day => {
                    day.classList.remove('selected');
                  });
                  const timeSlotContainer = document.getElementById('timeSlotContainer');
                  if (timeSlotContainer) timeSlotContainer.style.display = 'none';
                  localStorage.removeItem('ff_booking');
                }
              });
              paymentHandlerAttached = true;
            }
          } else {
            alert('Payment setup failed: ' + (result.message || 'Unknown error'));
          }
        } catch (error) {
          console.error('Payment error:', error);
          alert('Payment system error. Please try again or contact us directly.');
        }
      });
      
      // Form validation
      function validateForm() {
        const name = document.getElementById('customerName').value;
        const phone = document.getElementById('customerPhone').value;
        const vehicleYear = document.getElementById('vehicleYear').value;
        const vehicleMake = document.getElementById('vehicleMake').value;
        const vehicleModel = document.getElementById('vehicleModel').value;
        const vehicleColor = document.getElementById('vehicleColor').value;
        const serviceLevel = document.getElementById('serviceLevel').value;
        const timeSlot = document.getElementById('timeSlot')?.value || '';
        
        if (!name || !phone || !vehicleYear || !vehicleMake || !vehicleModel || !vehicleColor || !serviceLevel) {
          alert('Please fill in all required fields.');
          return false;
        }
        
        if (!selectedDate) {
          alert('Please select a date for your appointment.');
          return false;
        }
        
        if (!timeSlot) {
          alert('Please select a time slot for your appointment.');
          return false;
        }
        
        return true;
      }
      
      // Initialize calendar
      loadCalendar();

      // If returning from Stripe redirect, finalize booking
      (async function finalizeIfRedirected() {
        try {
          const params = new URLSearchParams(window.location.search);
          const paymentIntentId = params.get('payment_intent');
          const redirectStatus = params.get('redirect_status');
          if (paymentIntentId && redirectStatus === 'succeeded') {
            const bookingStored = JSON.parse(localStorage.getItem('ff_booking') || '{}');
            if (bookingStored && bookingStored.date && bookingStored.name) {
              const confirmRes = await fetch('/api/confirm-payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  paymentIntentId,
                  date: bookingStored.date,
                  name: bookingStored.name,
                  phone: bookingStored.phone,
                  timeSlot: bookingStored.timeSlot,
                  vehicleYear: bookingStored.vehicleYear,
                  vehicleMake: bookingStored.vehicleMake,
                  vehicleModel: bookingStored.vehicleModel,
                  vehicleTrim: bookingStored.vehicleTrim,
                  vehicleColor: bookingStored.vehicleColor,
                  serviceLevel: bookingStored.serviceLevel
                })
              });
              const confirmJson = await confirmRes.json();
              if (confirmJson.success) {
                alert('Thanks for booking! If you don\'t hear from Jason in the next hour, give him a call!');
                localStorage.removeItem('ff_booking');
                // Clean URL params
                window.history.replaceState({}, document.title, window.location.pathname);
              } else {
                alert('Booking confirmation failed: ' + (confirmJson.message || 'Unknown error'));
              }
            }
          }
        } catch (e) {
          console.error('Finalize redirect error:', e);
        }
      })();
    });
  </script>
</body>
</html>
