<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flawless Finish Ceramic Coating – Palm Springs & Coachella Valley</title>
  <meta name="description" content="Premium automotive ceramic coating with transparent pricing, real-time calendar booking with $250 deposit, and meticulous multi-stage prep for desert conditions." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="images/favicon.png">
</head>
<body>
  <header class="hero">
    <div class="wrap">
      <div>
        <div class="logo-section">
          <img src="images/flawless-finish-logo.png" alt="Flawless Finish Ceramic Coating Logo" class="logo">
        </div>
        <p class="lead">Desert‑luxe ceramic protection for Palm Springs & Coachella Valley — UV, heat, and sand defense with mirror‑grade gloss.</p>
        <div class="badges">
          <span class="badge">Owner: Jason (Jay)</span>
          <span class="badge">Call: 442‑342‑3627</span>
          <span class="badge">Deposit: $250</span>
          <span class="badge">Mobile & Shop Service</span>
        </div>
        <div class="cta-row">
          <a href="#booking" class="button primary">Book Now</a>
          <a href="#pricing" class="button secondary">See Pricing</a>
        </div>
      </div>
      <div class="card dark">
        <h2 style="margin-top:0">What You Get</h2>
        <p class="sub">Engineered process for harsh desert conditions.</p>
        <ul>
          <li>Decontamination, clay, polish, panel wipe</li>
          <li>2–5 year ceramic options</li>
          <li>Hydrophobic, UV & oxidation resistant</li>
          <li>Glass & wheel coating add‑ons</li>
        </ul>
      </div>
    </div>
  </header>

  <main>
    <section class="section light gallery-section">
      <div class="container">
        <h2>Ceramic Gallery</h2>
        <p class="sub">Premium ceramic coating results from Palm Springs & Coachella Valley</p>
        <div class="gallery">
          <div class="gallery-item">
            <img src="images/gallery/bmw-interior-dashboard.jpg" alt="BMW M interior with ceramic coating on dashboard">
            <div class="gallery-caption">Interior Dashboard Protection</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/057FFDFF-A80A-4DF3-8735-3710F23DCCEE.jpeg" alt="Professional ceramic coating work">
            <div class="gallery-caption">Professional Ceramic Coating</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/3839ED0E-8F5A-40E3-9F22-2F911F6627B1.jpeg" alt="High-quality ceramic coating results">
            <div class="gallery-caption">Premium Results</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/6CF20334-6867-4342-A413-556E0D905B8E_1_105_c.jpeg" alt="Ceramic coating detail work">
            <div class="gallery-caption">Detail Work</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/70DB7259-DC31-4EC2-913D-F8A373EBDB38_1_105_c.jpeg" alt="Ceramic coating application">
            <div class="gallery-caption">Expert Application</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/70FDC29D-56A6-47A8-AFC5-DB2F69BCA841_1_105_c.jpeg" alt="Ceramic coating transformation">
            <div class="gallery-caption">Complete Transformation</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/749F8F04-9A69-4A87-9429-C1BBA9335E7F_1_105_c.jpeg" alt="Professional detailing work">
            <div class="gallery-caption">Professional Detailing</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/7D953D53-8255-4D6E-9C69-62585AB09E28_1_105_c.jpeg" alt="Ceramic coating finish">
            <div class="gallery-caption">Flawless Finish</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/9F36238E-7005-43C1-AD72-0206771E5AE0_1_105_c.jpeg" alt="High-end ceramic coating">
            <div class="gallery-caption">High-End Protection</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/9F871EEB-B45D-4866-BD38-628EEA5F68D8_1_105_c.jpeg" alt="Ceramic coating results">
            <div class="gallery-caption">Premium Results</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/A382230E-5034-4041-86B3-4A7AE10DF928.jpeg" alt="Professional ceramic coating service">
            <div class="gallery-caption">Expert Service</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/B2040A7B-381B-493E-81E0-1F86560EB65A.jpeg" alt="Ceramic coating protection">
            <div class="gallery-caption">Long-Lasting Protection</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/C00CD066-53A0-4AA6-A96A-202C53EF3D05_1_105_c.jpeg" alt="Premium ceramic coating">
            <div class="gallery-caption">Premium Coating</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/CE0C9E15-4FDA-4ED7-BF37-8FDBA44F23EA.jpeg" alt="Ceramic coating detail">
            <div class="gallery-caption">Attention to Detail</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/ED593E8B-486F-46CA-BC83-8B06226C1B83_1_105_c.jpeg" alt="Professional detailing">
            <div class="gallery-caption">Professional Detailing</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/FE9424FB-2A65-478A-8774-F4A98D9E4BF0.jpeg" alt="Ceramic coating finish">
            <div class="gallery-caption">Flawless Finish</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/acura-restored-headlight.jpg" alt="Acura headlight restoration">
            <div class="gallery-caption">Headlight Restoration</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/bmw-interior-red-leather.jpg" alt="BMW interior red leather protection">
            <div class="gallery-caption">Interior Protection</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/bmw-light-blue-mirror.jpg" alt="BMW light blue mirror finish">
            <div class="gallery-caption">Mirror Finish</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/bmw-m5-water-droplets.jpg" alt="BMW M5 water beading effect">
            <div class="gallery-caption">Water Beading Effect</div>
          </div>
          <div class="gallery-item">
            <img src="images/gallery/bmw-soap-washing.jpg" alt="BMW being washed">
            <div class="gallery-caption">Easy Maintenance</div>
          </div>
        </div>
        <div class="gallery-cta">
          <a href="#booking" class="button primary">Book Your Ceramic Coating</a>
          <a href="#pricing" class="button secondary">View Pricing</a>
        </div>
      </div>
    </section>

    <section class="section dark before-after-section">
      <div class="container">
        <h2>Before & After Gallery</h2>
        <p class="sub">See the transformation - from damaged to flawless</p>
        <div class="before-after-gallery">
          <div class="before-after-item">
            <div class="before-after-image">
              <img src="images/before-after/paint-swirls-before.jpg" alt="Paint with swirl marks and scratches - before">
              <div class="before-after-label">Before</div>
            </div>
            <div class="before-after-image">
              <img src="images/before-after/paint-mirror-finish-after.jpg" alt="Perfect mirror finish after ceramic coating - after">
              <div class="before-after-label">After</div>
            </div>
            <div class="before-after-caption">Paint Correction & Ceramic Coating</div>
          </div>
          <div class="before-after-item">
            <div class="before-after-image">
              <img src="images/before-after/headlight-oxidized-before.jpg" alt="Acura with severely oxidized, hazy headlight - before">
              <div class="before-after-label">Before</div>
            </div>
            <div class="before-after-image">
              <img src="images/before-after/headlight-restored-after.jpg" alt="Acura with crystal clear, restored headlight and ceramic coating - after">
              <div class="before-after-label">After</div>
            </div>
            <div class="before-after-caption">Headlight Restoration & Ceramic Coating</div>
          </div>
        </div>
        <div class="before-after-cta">
          <a href="#booking" class="button primary">Transform Your Vehicle</a>
          <a href="tel:4423423627" class="button secondary">Call (442) 342-3627</a>
        </div>
      </div>
    </section>

    <section class="section about-me">
      <div class="container">
        <div class="about-content">
          <div class="about-text">
            <h2>About Me</h2>
            <p class="lead">Upgrading Great to Excellence</p>
            <p>Hi, I'm Jason — the owner and operator of Flawless Finish Ceramic Coating here in sunny Palm Springs. My passion for cars started early. I began high-speed buffing at just 15 years old, and for the past <strong>28 years</strong> I've been perfecting my craft — restoring shine, depth, and protection to vehicles of all kinds.</p>
            
            <p>Originally from the Midwest, I bring those Indiana values of hard work, fairness, and loyalty into everything I do. At Flawless Finish, my focus is simple: deliver superior results and make every vehicle look better than new.</p>
            
            <p>For me, detailing isn't just about appearance — it's about pride, precision, and helping people fall in love with their cars all over again.</p>
            
            <p class="highlight">When you choose Flawless Finish Ceramic Coating, you're not just getting a service — you're getting a commitment to excellence.</p>
            
            <div class="credentials">
              <div class="credential">
                <span class="number">28</span>
                <span class="label">Years Experience</span>
              </div>
              <div class="credential">
                <span class="number">15</span>
                <span class="label">Started Age</span>
              </div>
              <div class="credential">
                <span class="number">∞</span>
                <span class="label">Cars Restored</span>
              </div>
            </div>
          </div>
          <div class="about-image">
            <img src="images/jason-headshot.jpg" alt="Jason - Owner of Flawless Finish Ceramic Coating" />
            <div class="image-caption">
              <strong>Jason</strong><br>
              Owner & Master Detailer
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="section testimonials">
      <div class="container">
        <h2>Clients in the Valley</h2>
        <p class="sub">Proof beats promises — what drivers say after living with the coating.</p>
        <div class="testi-grid">
          <div class="testi">
            <h3>"Desert dust just won't stick."</h3>
            <p>Six months later and rinses take minutes. The water beading hasn't quit.</p>
            <div class="by">— M., Indio</div>
          </div>
          <div class="testi">
            <h3>"Looks better than delivery day."</h3>
            <p>Paint correction + 5‑year coating. It turns heads in the sun.</p>
            <div class="by">— A., Palm Springs</div>
          </div>
          <div class="testi">
            <h3>"Professional, punctual, meticulous."</h3>
            <p>Explained each step. Zero surprises. Booking my SUV next.</p>
            <div class="by">— J.R., La Quinta</div>
          </div>
        </div>
      </div>
    </section>

    <section id="pricing" class="section light pricing-section">
      <div class="container">
        <h2>Transparent Pricing</h2>
        <div class="pricing-grid">
          <div class="pricing-card">
            <h3>Cars</h3>
            <div class="price">$800</div>
            <div class="description">Minimal Paint Correction</div>
            <ul>
              <li>Decontamination wash</li>
              <li>Clay bar treatment</li>
              <li>Light polish</li>
              <li>2-year ceramic coating</li>
            </ul>
            <a href="#booking" class="button primary">Book This Service</a>
          </div>
          <div class="pricing-card featured">
            <h3>Cars</h3>
            <div class="price">$900</div>
            <div class="description">Moderate Paint Correction</div>
            <ul>
              <li>Full decontamination</li>
              <li>Clay bar treatment</li>
              <li>Multi-stage polish</li>
              <li>3-year ceramic coating</li>
            </ul>
            <a href="#booking" class="button primary">Book This Service</a>
          </div>
          <div class="pricing-card">
            <h3>Cars</h3>
            <div class="price">$1,100</div>
            <div class="description">Heavy Paint Correction</div>
            <ul>
              <li>Complete decontamination</li>
              <li>Clay bar treatment</li>
              <li>Heavy compounding & polish</li>
              <li>5-year ceramic coating</li>
            </ul>
            <a href="#booking" class="button primary">Book This Service</a>
          </div>
        </div>
        <div class="pricing-note">
          <p><strong>Glass & Rims:</strong> Add $100-$150 depending on correction level</p>
        </div>
      </div>
    </section>

    <section class="section light process-section">
      <div class="container">
        <h2>Our Process</h2>
        <p class="sub">Meticulous preparation for lasting results</p>
        <div class="process-grid">
          <div class="process-step">
            <div class="step-number">1</div>
            <h3>Initial Inspection</h3>
            <p>Walk-around assessment with Jason and vehicle owner to identify scratches, swirl marks, oxidation, and contamination that need attention.</p>
          </div>
          <div class="process-step">
            <div class="step-number">2</div>
            <h3>Decontamination</h3>
            <p>Pre-wash and thorough decontamination using pH-neutral shampoo and iron removers to strip away old waxes, sealants, and embedded contaminants.</p>
          </div>
          <div class="process-step">
            <div class="step-number">3</div>
            <h3>Clay Bar Treatment</h3>
            <p>Clay bar used to remove any remaining bonded debris, leaving the surface smooth and ready for paint correction.</p>
          </div>
          <div class="process-step">
            <div class="step-number">4</div>
            <h3>Paint Correction</h3>
            <p>High-speed buffing/compounding to eliminate deeper imperfections and polishing to enhance gloss and remove swirl marks.</p>
          </div>
          <div class="process-step">
            <div class="step-number">5</div>
            <h3>Final Preparation</h3>
            <p>Final inspection under bright lighting and IPA solution wipe to remove any remaining oils or residues before coating application.</p>
          </div>
          <div class="process-step">
            <div class="step-number">6</div>
            <h3>Ceramic Coating</h3>
            <p>Ceramic coating applied one panel at a time. Once fully cured (7 days), you'll only need water to rinse and dry!</p>
          </div>
        </div>
      </div>
    </section>

    <section class="section light how-to-book-section">
      <div class="container">
        <h2>How to Book</h2>
        <p class="sub">Simple steps to secure your ceramic coating appointment</p>
        <div class="how-to-steps">
          <div class="step">
            <div class="step-number">1</div>
            <h3>Select Your Date</h3>
            <p>Choose your preferred appointment date from the dropdown menu</p>
          </div>
          <div class="step">
            <div class="step-number">2</div>
            <h3>Fill in Your Information</h3>
            <p>Enter your name, phone number, email, vehicle type, and service level</p>
          </div>
          <div class="step">
            <div class="step-number">3</div>
            <h3>Choose Payment Method</h3>
            <p>Select "Pay $250 Deposit" to secure your booking with a card payment, or choose cash payment</p>
          </div>
          <div class="step">
            <div class="step-number">4</div>
            <h3>Complete Payment</h3>
            <p>If paying by card, enter your payment details securely through our encrypted payment form</p>
          </div>
          <div class="step">
            <div class="step-number">5</div>
            <h3>Confirmation & Follow-up</h3>
            <p>You'll receive a confirmation email, and we'll contact you to finalize your appointment details</p>
          </div>
        </div>
      </div>
    </section>

    <section id="booking" class="section light booking-section">
      <div class="container">
        <div class="booking-header">
          <h2>Book Your Ceramic Coating</h2>
          <p class="booking-subtitle">Select your preferred date and complete your booking</p>
        </div>
        <div class="booking-container">
          <form class="booking-form" id="bookingForm">
            <div class="form-section">
              <h3 class="form-section-title">Appointment Date</h3>
              <div class="form-group">
                <label for="bookingDate">Select Your Date</label>
                <select id="bookingDate" name="bookingDate" required>
                  <option value="">Select your date</option>
                </select>
                <div id="nextSlot" class="next-available"></div>
              </div>
            </div>

            <div class="form-section">
              <h3 class="form-section-title">Contact Information</h3>
              <div class="form-row">
                <div class="form-group">
                  <label for="customerName">Full Name</label>
                  <input type="text" id="customerName" name="customerName" placeholder="Enter your full name" required>
                </div>
                
                <div class="form-group">
                  <label for="customerPhone">Phone Number</label>
                  <input type="tel" id="customerPhone" name="customerPhone" placeholder="(442) 555-1234" required>
                </div>
              </div>
              
              <div class="form-group">
                <label for="customerEmail">Email Address</label>
                <input type="email" id="customerEmail" name="customerEmail" placeholder="your.email@example.com" required>
              </div>
            </div>

            <div class="form-section">
              <h3 class="form-section-title">Service Details</h3>
              <div class="form-row">
                <div class="form-group">
                  <label for="vehicleType">Vehicle Type</label>
                  <select id="vehicleType" name="vehicleType" required>
                    <option value="">Select Vehicle Type</option>
                    <option value="car">Car</option>
                    <option value="truck">Truck</option>
                    <option value="suv">SUV</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="serviceLevel">Service Level</label>
                  <select id="serviceLevel" name="serviceLevel" required>
                    <option value="">Select Service Level</option>
                    <option value="minimal">Minimal Paint Correction - $800</option>
                    <option value="moderate">Moderate Paint Correction - $900</option>
                    <option value="heavy">Heavy Paint Correction - $1,100</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="payment-section">
              <h3 class="form-section-title">Payment Options</h3>
              <p class="payment-description">Choose how you'd like to secure your appointment</p>
              <div class="payment-options">
                <button type="button" id="cashBooking" class="button secondary">Book with Cash Payment</button>
                <button type="button" id="cardBooking" class="button primary">Pay $250 Deposit</button>
              </div>
              
              <div id="paymentForm" style="display: none;">
                <div id="payment-element">
                  <!-- Stripe Elements will be inserted here -->
                </div>
                <button type="submit" id="submit-payment" class="button primary">Pay $250 Deposit</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </section>
  </main>

  <footer class="section dark">
    <div class="container">
      <div class="text-center">
        <h3>Flawless Finish Ceramic Coating</h3>
        <p>Palm Springs & Coachella Valley</p>
        <p>Call: <a href="tel:4423423627" style="color: #007bff;">(442) 342-3627</a></p>
        <p>Owner: Jason (Jay)</p>
      </div>
    </div>
  </footer>

  <script>
    // Professional booking calendar functionality
    document.addEventListener('DOMContentLoaded', function() {
      const bookingDateSelect = document.getElementById('bookingDate');
      const nextSlot = document.getElementById('nextSlot');
      const cashBooking = document.getElementById('cashBooking');
      const cardBooking = document.getElementById('cardBooking');
      const paymentForm = document.getElementById('paymentForm');
      const bookingForm = document.getElementById('bookingForm');
      
      // Check if required elements exist
      if (!bookingDateSelect || !cashBooking || !cardBooking || !paymentForm || !bookingForm) {
        console.error('Required booking form elements not found');
        return;
      }
      
      let selectedDate = null;
      let stripe = null;
      
      // Load available dates into dropdown
      async function loadCalendar() {
        try {
          const response = await fetch('/api/availability?days=30');
          const data = await response.json();
          
          bookingDateSelect.innerHTML = '<option value="">Select your date</option>';
          let firstAvailable = null;
          
          data.days.forEach(day => {
            if (!day.booked) {
              const option = document.createElement('option');
              option.value = day.date;
              option.textContent = day.displayDate;
              bookingDateSelect.appendChild(option);
              
              if (!firstAvailable) {
                firstAvailable = day;
              }
            }
          });
          
          if (firstAvailable) {
            nextSlot.textContent = `Next available: ${firstAvailable.displayDate}`;
          } else {
            nextSlot.textContent = 'No available dates in the next 30 days';
            bookingDateSelect.innerHTML = '<option value="">No dates available</option>';
          }
        } catch (error) {
          console.error('Error loading calendar:', error);
          bookingDateSelect.innerHTML = '<option value="">Error loading dates</option>';
          nextSlot.textContent = 'Error loading calendar. Please refresh the page.';
        }
      }
      
      // Handle date selection from dropdown
      bookingDateSelect.addEventListener('change', function() {
        selectedDate = this.value || null;
      });
      
      // Cash booking handler
      cashBooking.addEventListener('click', async function() {
        if (!validateForm()) return;
        
        try {
          const formData = {
            date: bookingDateSelect.value || selectedDate,
            name: document.getElementById('customerName').value,
            phone: document.getElementById('customerPhone').value,
            email: document.getElementById('customerEmail').value.trim(),
            vehicleType: document.getElementById('vehicleType').value,
            serviceLevel: document.getElementById('serviceLevel').value,
            paymentMethod: 'cash'
          };
          
          const response = await fetch('/api/book-cash', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert('Cash booking submitted successfully! We will contact you to confirm your appointment.');
            bookingForm.reset();
            selectedDate = null;
            loadCalendar(); // Reload available dates
          } else {
            alert('Booking failed: ' + (result.message || 'Unknown error'));
          }
        } catch (error) {
          console.error('Booking error:', error);
          alert('Network error. Please try again.');
        }
      });
      
      // Card booking handler
      cardBooking.addEventListener('click', async function(e) {
        e.preventDefault();
        console.log('Pay $250 Deposit button clicked');
        
        // Validate form first
        if (!validateForm()) {
          console.log('Form validation failed');
          return;
        }
        
        // Disable button to prevent double-clicks
        cardBooking.disabled = true;
        cardBooking.textContent = 'Processing...';
        
        try {
          console.log('Initializing Stripe...');
          
          // Initialize Stripe
          if (!window.Stripe) {
            console.log('Loading Stripe script...');
            const script = document.createElement('script');
            script.src = 'https://js.stripe.com/v3/';
            document.head.appendChild(script);
            await new Promise((resolve, reject) => {
              script.onload = resolve;
              script.onerror = () => reject(new Error('Failed to load Stripe script'));
            });
            console.log('Stripe script loaded');
          }
          
          // Get Stripe publishable key
          console.log('Fetching Stripe publishable key...');
          const keyResponse = await fetch('/api/stripe-key');
          
          if (!keyResponse.ok) {
            throw new Error('Failed to get Stripe key: ' + keyResponse.status);
          }
          
          const keyData = await keyResponse.json();
          const publishableKey = keyData.publishableKey;
          
          if (!publishableKey) {
            alert('Payment system not configured. Please contact us directly at (442) 342-3627.');
            cardBooking.disabled = false;
            cardBooking.textContent = 'Pay $250 Deposit';
            return;
          }
          
          console.log('Initializing Stripe with key...');
          stripe = Stripe(publishableKey);
          
          // Create payment intent
          const formData = {
            date: bookingDateSelect.value || selectedDate,
            name: document.getElementById('customerName').value.trim(),
            phone: document.getElementById('customerPhone').value.trim(),
            email: document.getElementById('customerEmail').value.trim(),
            vehicleType: document.getElementById('vehicleType').value,
            serviceLevel: document.getElementById('serviceLevel').value
          };
          
          console.log('Creating payment intent with data:', formData);
          
          const response = await fetch('/api/create-payment-intent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to create payment intent');
          }
          
          const result = await response.json();
          console.log('Payment intent created:', result);
          
          if (result.success && result.clientSecret) {
            // Initialize Stripe Elements
            console.log('Initializing Stripe Elements...');
            const elements = stripe.elements({
              clientSecret: result.clientSecret
            });
            
            const paymentElement = elements.create('payment');
            paymentElement.mount('#payment-element');
            
            paymentForm.style.display = 'block';
            
            // Scroll to payment form
            paymentForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Handle form submission - remove old listener first
            const oldSubmitHandler = bookingForm._submitHandler;
            if (oldSubmitHandler) {
              bookingForm.removeEventListener('submit', oldSubmitHandler);
            }
            
            // Create new submit handler
            const submitHandler = async function(e) {
              e.preventDefault();
              console.log('Submitting payment...');
              
              const submitBtn = document.getElementById('submit-payment');
              submitBtn.disabled = true;
              submitBtn.textContent = 'Processing Payment...';
              
              try {
                const { error, paymentIntent } = await stripe.confirmPayment({
                  elements,
                  confirmParams: {
                    return_url: window.location.href
                  },
                  redirect: 'if_required'
                });
                
                if (error) {
                  console.error('Payment error:', error);
                  alert('Payment failed: ' + error.message);
                  submitBtn.disabled = false;
                  submitBtn.textContent = 'Pay $250 Deposit';
                } else if (paymentIntent && paymentIntent.status === 'succeeded') {
                  // Confirm booking on server
                  const confirmResponse = await fetch('/api/confirm-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      paymentIntentId: paymentIntent.id,
                      date: bookingDateSelect.value || formData.date,
                      name: formData.name,
                      phone: formData.phone,
                      email: formData.email || document.getElementById('customerEmail').value.trim(),
                      vehicleType: document.getElementById('vehicleType').value,
                      serviceLevel: document.getElementById('serviceLevel').value
                    })
                  });
                  
                  const confirmResult = await confirmResponse.json();
                  
                  if (confirmResult.success) {
                    alert('Payment successful! Your booking has been confirmed. We will contact you soon.');
                    bookingForm.reset();
                    paymentForm.style.display = 'none';
                    selectedDate = null;
                    loadCalendar(); // Reload available dates
                  } else {
                    alert('Payment succeeded but booking confirmation failed. Please contact us at (442) 342-3627.');
                  }
                }
              } catch (err) {
                console.error('Payment confirmation error:', err);
                alert('Payment processing error. Please try again or contact us directly.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Pay $250 Deposit';
              }
            };
            
            // Store handler reference and attach
            bookingForm._submitHandler = submitHandler;
            bookingForm.addEventListener('submit', submitHandler);
            
            // Re-enable button
            cardBooking.disabled = false;
            cardBooking.textContent = 'Pay $250 Deposit';
          } else {
            throw new Error(result.message || 'Payment setup failed');
          }
        } catch (error) {
          console.error('Payment error:', error);
          alert('Payment system error: ' + error.message + '. Please try again or contact us directly at (442) 342-3627.');
          cardBooking.disabled = false;
          cardBooking.textContent = 'Pay $250 Deposit';
        }
      });
      
      // Form validation
      function validateForm() {
        const name = document.getElementById('customerName').value.trim();
        const phone = document.getElementById('customerPhone').value.trim();
        const vehicleType = document.getElementById('vehicleType').value;
        const serviceLevel = document.getElementById('serviceLevel').value;
        
        if (!name || name.length < 2) {
          alert('Please enter your full name (at least 2 characters).');
          document.getElementById('customerName').focus();
          return false;
        }
        
        if (!phone || phone.length < 10) {
          alert('Please enter a valid phone number.');
          document.getElementById('customerPhone').focus();
          return false;
        }
        
        const email = document.getElementById('customerEmail').value.trim();
        if (!email) {
          alert('Please enter your email address.');
          document.getElementById('customerEmail').focus();
          return false;
        }
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          alert('Please enter a valid email address.');
          document.getElementById('customerEmail').focus();
          return false;
        }
        
        if (!vehicleType) {
          alert('Please select a vehicle type.');
          document.getElementById('vehicleType').focus();
          return false;
        }
        
        if (!serviceLevel) {
          alert('Please select a service level.');
          document.getElementById('serviceLevel').focus();
          return false;
        }
        
        if (!selectedDate || !bookingDateSelect.value) {
          alert('Please select a date for your appointment.');
          bookingDateSelect.focus();
          return false;
        }
        
        return true;
      }
      
      // Initialize calendar
      loadCalendar();
    });
  </script>
</body>
</html>